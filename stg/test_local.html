<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache">
    <title>Mini App Local Test</title>
    <script src="tailwind-3.4.17.js"></script>
</head>
<body class="font-[system-ui,sans-serif] max-w-3xl mx-auto my-10 px-5 bg-gray-100">
    <h1 class="text-gray-800 text-3xl font-bold mb-6">üß™ Local Mini App Tester</h1>
    
    <div class="bg-white p-5 rounded-lg mb-5 shadow-sm">
        <h2 class="text-xl font-semibold mb-3">Generate Test URL</h2>
        <p class="mb-4">Click the button to generate a test URL with sample data:</p>
        <div class="gap-2.5 flex">
            <button onclick="generateTestUrl()" class="bg-blue-600 text-white px-6 py-3 rounded cursor-pointer text-base hover:bg-blue-700">Generate URL</button>
            <button onclick="openMiniApp()" class="bg-blue-600 text-white px-6 py-3 rounded cursor-pointer text-base hover:bg-blue-700">Open Mini App</button>
        </div>
        
        <div id="result"></div>
    </div>

    <div class="bg-white p-5 rounded-lg mb-5 shadow-sm">
        <h2 class="text-xl font-semibold mb-3">Sample Data Being Used</h2>
        <pre id="sampleData" class="bg-gray-100 p-2.5 rounded overflow-x-auto overflow-y-auto max-h-64 text-sm"></pre>
    </div>

    <div class="bg-blue-50 p-4 rounded">
        <strong>üìù Note:</strong> The mini app won't be able to use <code class="bg-gray-200 px-1 rounded">sendData()</code> 
        outside of Telegram, but you can test the UI, calendar, slot selection, and compression.
        The Telegram WebApp SDK will show warnings in the console - this is normal for local testing.
    </div>

    <script>
        // Generate full stress test data: Oct-Jan with 70% filled heatmap and all slots selected
        function generateStressTestData() {
            const whitelisted_sessions = {};
            const heatmap = {};
            const allSlots = ["1.0", "2.0", "3.0", "4.0", "5.0", "6.0", "7.0"];
            
            // October 2025 (from 20th onwards)
            for (let day = 20; day <= 31; day++) {
                const dateStr = `${String(day).padStart(2, '0')}/10/2025`;
                whitelisted_sessions[dateStr] = [...allSlots];
                heatmap[dateStr] = {};
                allSlots.forEach(slot => {
                    // 70% chance to have heat (random 1-15)
                    if (Math.random() < 0.7) {
                        heatmap[dateStr][slot] = Math.floor(Math.random() * 15) + 1;
                    }
                });
            }
            
            // November 2025 (all days)
            for (let day = 1; day <= 30; day++) {
                const dateStr = `${String(day).padStart(2, '0')}/11/2025`;
                whitelisted_sessions[dateStr] = [...allSlots];
                heatmap[dateStr] = {};
                allSlots.forEach(slot => {
                    if (Math.random() < 0.7) {
                        heatmap[dateStr][slot] = Math.floor(Math.random() * 15) + 1;
                    }
                });
            }
            
            // December 2025 (all days)
            for (let day = 1; day <= 31; day++) {
                const dateStr = `${String(day).padStart(2, '0')}/12/2025`;
                whitelisted_sessions[dateStr] = [...allSlots];
                heatmap[dateStr] = {};
                allSlots.forEach(slot => {
                    if (Math.random() < 0.7) {
                        heatmap[dateStr][slot] = Math.floor(Math.random() * 15) + 1;
                    }
                });
            }
            
            // January 2026 (all days)
            for (let day = 1; day <= 31; day++) {
                const dateStr = `${String(day).padStart(2, '0')}/01/2026`;
                whitelisted_sessions[dateStr] = [...allSlots];
                heatmap[dateStr] = {};
                allSlots.forEach(slot => {
                    if (Math.random() < 0.7) {
                        heatmap[dateStr][slot] = Math.floor(Math.random() * 15) + 1;
                    }
                });
            }
            
            return {
                course_name: "Class 3 Practical Lesson - Manual",
                team_name: "Standard - Ubi",
                whitelisted_sessions,
                heatmap,
                stop_after_one_slot: false,
                stop_at_midnight: true,
                back_to_back_only: false,
                exclude_current_day: true,
                daily_lesson_limit: 2,
                credits_per_slot: 1
            };
        }
        
        const sampleData = generateStressTestData();

        // Display full sample data
        document.getElementById('sampleData').textContent = JSON.stringify(sampleData, null, 2);

        // Compress data function (same as in app.js)
        async function compressData(data) {
            const jsonString = JSON.stringify(data);
            const bytes = new TextEncoder().encode(jsonString);
            
            const stream = new Response(bytes).body.pipeThrough(
                new CompressionStream('gzip')
            );
            const compressed = await new Response(stream).arrayBuffer();
            const compressedBytes = new Uint8Array(compressed);
            
            let binary = '';
            for (let i = 0; i < compressedBytes.length; i++) {
                binary += String.fromCharCode(compressedBytes[i]);
            }
            const base64 = btoa(binary);
            return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
        }

        let testUrl = '';

        async function generateTestUrl() {
            try {
                const compressed = await compressData(sampleData);
                testUrl = window.location.href.replace(/test_local(\.html)?$/, `index.html?data=${compressed}`);
                
                const withinLimit = testUrl.length <= 4096;
                
                document.getElementById('result').innerHTML = `
                    <div class="mt-4">
                        <strong class="text-green-700">
                            ${withinLimit ? '‚úì' : '‚úó'} URL Generated!
                        </strong>
                        <div class="mt-2.5">
                            <strong>URL Length:</strong> ${testUrl.length} / 4096 characters
                            ${withinLimit ? '<span class="text-green-700">(‚úì Within limit)</span>' : '<span class="text-red-700">(‚úó EXCEEDS LIMIT!)</span>'}
                        </div>
                        <div class="mt-2.5">
                            <strong>Compressed Size:</strong> ${compressed.length} chars
                        </div>
                        <div class="mt-2.5">
                            <strong>Original JSON:</strong> ${JSON.stringify(sampleData).length} chars
                        </div>
                        <div class="mt-2.5">
                            <strong>Compression Ratio:</strong> ${(compressed.length / JSON.stringify(sampleData).length * 100).toFixed(1)}%
                        </div>
                        <div class="mt-2.5">
                            <strong>Full Test URL:</strong>
                        </div>
                        <div class="bg-gray-100 p-4 rounded mt-2.5 font-mono text-sm overflow-x-auto overflow-y-auto max-h-32 border border-gray-300 break-all">${testUrl}</div>
                        <button onclick="copyUrl()" class="mt-2.5 bg-blue-600 text-white px-6 py-3 rounded cursor-pointer text-base hover:bg-blue-700">Copy Full URL</button>
                    </div>
                `;
            } catch (error) {
                document.getElementById('result').innerHTML = `
                    <div class="text-red-700 mt-4">
                        <strong>‚úó Error:</strong> ${error.message}
                    </div>
                `;
            }
        }

        function openMiniApp() {
            if (testUrl) {
                window.open(testUrl, '_blank');
            } else {
                alert('Generate URL first!');
            }
        }

        function copyUrl() {
            navigator.clipboard.writeText(testUrl).then(() => {
                alert('URL copied to clipboard!');
            });
        }

        // Auto-generate on load
        window.addEventListener('load', generateTestUrl);
    </script>
</body>
</html>
